#@ load("@ytt:data", "data")
#@ load("@ytt:yaml", "yaml")
#@ load("/lib/helpers.star", "get_bom_data_for_tkr_name", "ValuesFormatStr")
#@ load("calico_addon_data.lib.yaml", "calicodatavalues")

#@ def calicopackageyaml():
---
apiVersion: packaging.carvel.dev/v1alpha1
kind: PackageInstall
metadata:
  name: calico
  namespace: tkg-system
spec:
  serviceAccountName: tanzu-addons-package-sa
  packageRef:
    #! PackageName is available in TKR BOM under the particular path listed below. We do not have to validate the key existence
    #! is because YTT will throw error if any struct is None or keys are missing, we expect to see those error and templating
    #! will be exit immediately.
    refName: #@ get_bom_data_for_tkr_name().addons["calico"].packageName
    versionSelection:
      prereleases: {}
  values:
  - secretRef:
      name: calico-data-values
---
apiVersion: v1
kind: Secret
metadata:
  name: calico-data-values
  namespace: tkg-system
type: Opaque
stringData:
  values.yaml: #@ ValuesFormatStr.format(yaml.encode(calicodatavalues()))

#@ end
